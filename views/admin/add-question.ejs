<%- include('../layouts/admin/header') %>
  <!--begin::Body-->

  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <!--begin::App Wrapper-->
    <div class="app-wrapper">
      <%- include('../layouts/admin/navbar-sidebar') %>
        <!--begin::App Main-->
        <main class="app-main">
          <!--begin::App Content Header-->
          <div class="app-content-header">
            <!--begin::Container-->
            <div class="container-fluid">
              <!--begin::Row-->
              <div class="row">
                <div class="col-sm-6">
                  <h3 class="mb-0">Add Question</h3>
                </div>
                <!-- <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                  <li class="breadcrumb-item"><a href="#">Home</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                </ol>
              </div> -->
              </div>
              <!--end::Row-->
            </div>
            <!--end::Container-->
          </div>
          <!--end::App Content Header-->
          <!--begin::App Content-->
          <div class="app-content">
            <!--begin::Container-->
            <div class="container-fluid">

              <div class="container py-1">
                <div class="card shadow-sm">
                  <div class="card-header">
                    <h5 class="mb-0">Add Question</h5>
                  </div>
                  <div class="card-body">
                    <div id="messageArea"></div>

                    <form id="add-question-form">


                      <div class="mb-3">
                        <label for="exam" class="form-label required">Select Exam</label>
                        <select class="form-select" id="exam" name="exam">
                          <option value="" disabled selected>Select Exam</option>
                          <%if(exams.length>0){
                            for(const exam of exams){
                            %>
                            <option value="<%=exam._id %>">
                              <%=exam.title%>
                            </option>

                            <% } } %>
                        </select>
                      </div>

                      <div class="mb-3">
                        <label for="questionText" class="form-label required">Question</label>
                        <textarea class="form-control" id="questionText" name="questionText" rows="3"
                          placeholder="Enter question"></textarea>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Options</label>

                        <div class="mb-2">
                          <label for="optionA" class="form-label required">Option A</label>
                          <input type="text" class="form-control" id="optionA" name="optionA">
                        </div>

                        <div class="mb-2">
                          <label for="optionB" class="form-label required">Option B</label>
                          <input type="text" class="form-control" id="optionB" name="optionB" >
                        </div>

                        <div class="mb-2">
                          <label for="optionC" class="form-label required">Option C</label>
                          <input type="text" class="form-control" id="optionC" name="optionC" >
                        </div>

                        <div class="mb-2">
                          <label for="optionD" class="form-label required">Option D</label>
                          <input type="text" class="form-control" id="optionD" name="optionD" >
                        </div>
                      </div>

                      <div class="mb-5">
                        <label for="correctOption" class="form-label required">Correct Option</label>
                        <select class="form-select" id="correctOption" name="correctOption">
                          <option value="" disabled selected>Select the correct option</option>
                          <option value="A">Option A</option>
                          <option value="B">Option B</option>
                          <option value="C">Option C</option>
                          <option value="D">Option D</option>
                        </select>
                      </div>

                      <div class="text-start">
                        <button type="submit" class="btn btn-primary">Save</button>
                      </div>

                    </form>
                  </div>
                </div>
              </div>





            </div>
            <!--end::Container-->
          </div>
          <!--end::App Content-->
        </main>
        <!--end::App Main-->

        <%- include('../layouts/admin/footer') %>

          <script>
            $(document).ready(function () {

              $('#add-question-form').submit(function (e) {
                e.preventDefault();

                const exam = $('#exam').val();
                const questionText = $('#questionText').val().trim();
                const optionA = $('#optionA').val().trim();
                const optionB = $('#optionB').val().trim();
                const optionC = $('#optionC').val().trim();
                const optionD = $('#optionD').val().trim();
                const correctOption = $('#correctOption').val();

                if (!exam || !questionText || !optionA || !optionB || !optionC || !optionD || !correctOption) {
                  showMessage('Please fill all the required fileds', 'danger');
                  return;
                }

                const formData = {
                  exam,
                  questionText,
                  options: [
                    { optionId: 'A', text: optionA },
                    { optionId: 'B', text: optionB },
                    { optionId: 'C', text: optionC },
                    { optionId: 'D', text: optionD }
                  ],
                  correctOption
                };

                // console.log(formData);

                $.ajax({
                  url: '/admin/questions/add',
                  type: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify(formData),
                  success: function (response) {
                    if (response.status) {
                      showMessage(response.message, 'success');
                      $('#add-question-form')[0].reset();
                    }
                  },
                  error: function (xhr) {
                    if (handleAuthRedirect(xhr)) return;
                    const errMsg = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Something went wrong!';
                    showMessage(errMsg, 'danger');
                  }

                })

              });


              function showMessage(message, type = 'success') {
                $('#messageArea').html(`
          <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          `);
             
          setTimeout(() => {
                  $('.alert').alert('close');
                }, 3000);

              }

              function handleAuthRedirect(error) {
                                const response = error.responseJSON;
                                if (error.status === 401) {
                                    window.location.href = '/admin/login';
                                    return true;
                                }
                                return false;
                            }

            })
          </script>
  </body>
  <!--end::Body-->

  </html>