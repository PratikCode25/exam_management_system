<%- include('../layouts/admin/header') %>
    <!--begin::Body-->

    <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
        <!--begin::App Wrapper-->
        <div class="app-wrapper">
            <%- include('../layouts/admin/navbar-sidebar') %>
                <!--begin::App Main-->
                <main class="app-main">
                    <!--begin::App Content Header-->
                    <div class="app-content-header">
                        <!--begin::Container-->
                        <div class="container-fluid">
                            <!--begin::Row-->
                            <div class="row">
                                <div class="col-sm-6">
                                    <h3 class="mb-0">Manage Course</h3>
                                </div>
                            </div>
                            <!--end::Row-->
                        </div>
                        <!--end::Container-->
                    </div>
                    <!--end::App Content Header-->
                    <!--begin::App Content-->
                    <div class="app-content">

                        <div class="container-fluid">

                            <div class="container py-1">
                                <div class="row justify-content-center">
                                    <div class="col-sm-6">


                                        <div class="card shadow-sm mb-4">
                                            <div class="card-header">
                                                <h4 class="mb-0">Add/Edit Course</h4>
                                            </div>
                                            <div class="card-body">

                                                <div id="messageArea"></div>

                                                <form id="course-form">
                                                    <input type="hidden" id="courseId" value="">
                                                    <div class="mb-3">
                                                        <label for="courseName" class="form-label required">Course
                                                            Name</label>
                                                        <input type="text" class="form-control" id="name" name="name">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="courseDescription" class="form-label">Course
                                                            Description</label>
                                                        <textarea class="form-control" id="description"
                                                            name="description" rows="3"></textarea>
                                                    </div>
                                                    <button type="submit" class="btn btn-primary">Save Course</button>
                                                    <button type="reset" class="btn btn-secondary" id="cancelEdit"
                                                        style="display: none;">Cancel</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">Course List</h5>
                                </div>


                                <div class="table-responsive shadow rounded p-3">
                                    <table class="table table-hover align-middle" id="courseTable">
                                        <thead class="table-primary">
                                            <tr>
                                                <th>Sl. No</th>
                                                <th>Name</th>
                                                <th>Description</th>
                                                <th class="text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="course-body">

                                        </tbody>
                                    </table>

                                    <nav class="d-flex justify-content-between align-items-center">
                                        <div id="page-info" class="text-muted ps-2"></div>
                                        <div class="flex-grow-1 d-flex justify-content-center">
                                            <div class="pagination-buttons">
                                                <button id="prev-btn" class="pagination-btn">Previous</button>
                                                <button id="next-btn" class="pagination-btn">Next</button>
                                            </div>
                                        </div>
                                    </nav>

                                </div>

                            </div>




                        </div>
                        <!--end::Container-->
                    </div>
                    <!--end::App Content-->
                </main>
                <!--end::App Main-->

                <%- include('../layouts/admin/footer') %>

                    <script>
                        $(document).ready(function () {
                            let currentPage = 1;
                            function fetchCourses(currentPage) {
                                $('#course-body').empty();
                                $.ajax({
                                    url: '/admin/courses/pagination',
                                    type: 'GET',
                                    data: { page: currentPage },
                                    success: function (response) {
                                        if (response.status) {
                                            // console.log(response.data);

                                            let html = '';
                                            if (response.data.length > 0) {
                                                response.data.forEach((course, index) => {
                                                    html += `
                                                    <tr class="fade-in" id='row-${course._id}'>
                                                          <td>${index + 1}</td>
                                                          <td>${course.name}</td>
                                                          <td>${course.description}</td>
                                                          <td class="text-center">
                                                          <button class="btn btn-sm btn-warning me-1 edit-btn" data-course-id="${course._id}">Edit</button>
                                                         <button class="btn btn-sm btn-danger delete-btn" data-course-id="${course._id}")">Delete</button>
                                                         </td>
                                                     </tr>   
                                                    `
                                                })
                                            } else {
                                                html += `
                                                <tr>
                                                <td colspan='5' class='text-center'> No Data Found </td>
                                                </tr>   
                                                `
                                            }
                                            // $('#course-body').append(html);
                                            $('#course-body').html(html);
                                            $('.fade-in').hide().fadeIn(500);

                                            // console.log(response);

                                            setupPagination(response.totalPages, response.page);

                                        }
                                    },
                                    error: function (error) {
                                        if (handleAuthRedirect(error)) return;
                                    }
                                })
                            }

                            $('#prev-btn').on('click', function () {
                                if (currentPage > 1) {
                                    currentPage--;
                                    fetchCourses(currentPage);
                                }
                            })

                            $('#next-btn').on('click', function () {
                                currentPage++;
                                fetchCourses(currentPage);

                            })

                            function setupPagination(totalPages, currentPage) {
                                // console.log(totalPages, currentPage);
                                $('#page-info').text(`Page ${currentPage} of ${totalPages}`);

                                $('#prev-btn').prop('disabled', currentPage === 1);
                                $('#next-btn').prop('disabled', currentPage === totalPages || totalPages === 0);
                            }

                            $('#course-form').submit(function (e) {
                                e.preventDefault();
                                const courseId = $('#courseId').val();
                                const formData = {
                                    name: $('#name').val().trim(),
                                    description: $('#description').val().trim()
                                }
                                if (!formData.name) {
                                    showMessage('Please fill all the required fileds', 'danger');
                                    return;
                                }
                                if (courseId) {

                                    $.ajax({
                                        url: `/admin/courses/${courseId}/update`,
                                        type: 'POST',
                                        contentType: 'application/json',
                                        data: JSON.stringify(formData),
                                        success: function (response) {
                                            if (response.status) {
                                                showMessage(response.message, 'success');
                                                $('#course-form')[0].reset();
                                                $('#courseId').val('');
                                                $('#cancelEdit').hide();
                                                fetchCourses(currentPage);

                                            }
                                        },
                                        error: function (error) {
                                            if (handleAuthRedirect(error)) return;
                                            const errMsg = error.responseJSON && error.responseJSON.message ? error.responseJSON.message : 'Something went wrong!';
                                            showMessage(errMsg, 'danger');
                                        }

                                    })


                                } else {
                                    $.ajax({
                                        url: '/admin/courses/add',
                                        type: 'POST',
                                        contentType: 'application/json',
                                        data: JSON.stringify(formData),
                                        success: function (response) {
                                            if (response.status) {
                                                showMessage(response.message, 'success');
                                                $('#course-form')[0].reset();
                                                fetchCourses(currentPage);

                                            }
                                        },
                                        error: function (error) {
                                            if (handleAuthRedirect(error)) return;
                                            const errMsg = error.responseJSON && error.responseJSON.message ? error.responseJSON.message : 'Something went wrong!';
                                            showMessage(errMsg, 'danger');
                                        }

                                    })
                                }
                            });


                            $(document).on('click', '.edit-btn', function () {
                                const courseId = $(this).data('course-id');
                                editCourse(courseId);
                            });

                            function editCourse(id) {
                                $.ajax({
                                    url: '/admin/courses/' + id,
                                    type: 'GET',
                                    success: function (response) {
                                        if (response.status) {
                                            // console.log(response.data);
                                            $('#name').val(response.data.name)
                                            $('#description').val(response.data.description);
                                            $('#courseId').val(response.data._id);
                                            $('#cancelEdit').show();
                                            $(`#row-${response.data._id}`).remove();

                                        }
                                    },
                                    error: function (error) {
                                        if (handleAuthRedirect(error)) return;
                                        const errMsg = error.responseJSON && error.responseJSON.message ? error.responseJSON.message : 'Something went wrong!';
                                        alert(errMsg);
                                    }
                                })
                            }

                            $('#cancelEdit').on('click', function () {
                                $('#courseId').val('')
                                $('#course-form')[0].reset();
                                $(this).hide();
                                fetchCourses(currentPage);
                            });

                            $(document).on('click', '.delete-btn', function () {
                                const courseId = $(this).data('course-id');
                                deleteCourse(courseId);
                            });

                            function deleteCourse(id) {
                                const conf = confirm('Are you sure you want to delete this course?');
                                if (!conf) {
                                    return false;
                                }

                                $.ajax({
                                    url: `/admin/courses/${id}/delete`,
                                    type: 'POST',
                                    success: function (response) {
                                        if (response.status) {
                                            $(`#row-${id}`).remove();
                                        }
                                    },
                                    error: function (error) {
                                        if (handleAuthRedirect(error)) return;
                                        console.log(error);
                                        alert('Something went wrong, can not delete course');

                                    }
                                })

                            }


                            fetchCourses(currentPage);

                            function showMessage(message, type = 'success') {
                                $('#messageArea').html(`
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `);

                                setTimeout(() => {
                                    $('.alert').alert('close');
                                }, 3000);

                            }


                            function handleAuthRedirect(error) {
                                const response = error.responseJSON;
                                if (error.status === 401) {
                                    window.location.href = '/admin/login';
                                    return true;
                                }
                                return false;
                            }


                        })

                    </script>

    </body>
    <!--end::Body-->

    </html>