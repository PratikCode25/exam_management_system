<%- include('../layouts/admin/header') %>
  <!--begin::Body-->

  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <!--begin::App Wrapper-->
    <div class="app-wrapper">
      <%- include('../layouts/admin/navbar-sidebar') %>
        <!--begin::App Main-->
        <main class="app-main">
          <!--begin::App Content Header-->
          <div class="app-content-header">
            <!--begin::Container-->
            <div class="container-fluid">
              <!--begin::Row-->
              <div class="row">
                <div class="col-sm-6">
                  <h3 class="mb-0">Manage Batch</h3>
                </div>
                <!-- <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                  <li class="breadcrumb-item"><a href="#">Home</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                </ol>
              </div> -->
              </div>
              <!--end::Row-->
            </div>
            <!--end::Container-->
          </div>
          <!--end::App Content Header-->
          <!--begin::App Content-->
          <div class="app-content">
            <!--begin::Container-->
            <div class="container-fluid">

              <div class="container py-1">

                <div class="card mb-4">
                  <div class="card-header">
                    <h4 class="mb-0">Add/Edit Batch</h4>
                  </div>
                  <div class="card-body">
                    <div id="messageArea"></div>
                    <form id="batch-form">
                      <input type="hidden" id="batchId" value="">
                      <div class="row g-3">
                        <div class="col-md-4">
                          <label for="course" class="form-label required">Course</label>
                          <select class="form-select" id="courseId" name="courseId">
                            <option value="" disabled>Select Course</option>
                            <% if(courses.length>0){
                              for(const course of courses){
                              %>
                              <option value="<%=course._id %>">
                                <%=course.name%>
                              </option>
                              <% } } %>
                          </select>
                        </div>
                        <div class="col-md-4">
                          <label for="batchName" class="form-label required">Batch Name</label>
                          <input type="text" class="form-control" id="name" name="name">
                        </div>
                        <div class="col-md-4">
                          <label for="startDate" class="form-label required">Start Date</label>
                          <input type="date" class="form-control" id="startDate" name="startDate">
                        </div>
                      </div>
                      <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Save Batch</button>
                        <button type="reset" class="btn btn-secondary" id="cancelEdit"
                          style="display: none;">Cancel</button>
                      </div>
                    </form>
                  </div>
                </div>


                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="mb-0">Batch List</h5>
                  <div class="col-md-4">
                    <select class="form-select" id="courseFilter" name="courseFilter">
                      <option value="">All Courses</option>
                      <% if(courses.length>0){
                        for(const course of courses){
                        %>
                        <option value="<%=course._id %>">
                          <%=course.name%>
                        </option>
                        <% } } %>
                    </select>
                  </div>
                </div>


                <div class="table-responsive shadow rounded p-3">
                  <table class="table table-hover align-middle" id="batchTable">
                    <thead class="table-primary">
                      <tr>
                        <th>Sl. No</th>
                        <th>Course</th>
                        <th>Batch Name</th>
                        <th>Start Date</th>
                        <th class="text-center">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="batch-body">

                    </tbody>
                  </table>

                  <nav class="d-flex justify-content-between align-items-center">
                    <div id="page-info" class="text-muted ps-2"></div>
                    <div class="flex-grow-1 d-flex justify-content-center">
                      <div class="pagination-buttons">
                        <button id="prev-btn" class="pagination-btn">Previous</button>
                        <button id="next-btn" class="pagination-btn">Next</button>
                      </div>
                    </div>
                  </nav>

                </div>




              </div>
              <!--end::Container-->
            </div>
            <!--end::App Content-->
        </main>
        <!--end::App Main-->

        <%- include('../layouts/admin/footer') %>

          <script>
            $(document).ready(function () {
              let currentPage = 1;
              function fetchBatches(currentPage) {
                let courseFilterId = $('#courseFilter').val();
                let page = currentPage;
                $('#batch-body').empty();
                $.ajax({
                  url: '/admin/batches/pagination',
                  type: 'GET',
                  data: {
                    courseId: courseFilterId,
                    page
                  },
                  success: function (response) {
                    if (response.status) {
                      // console.log(response.data);

                      renderBatches(response.data);
                      setupPagination(response.totalPages, response.page)

                    }
                  },
                  error: function (error) {
                    if (handleAuthRedirect(error)) return;
                  }
                })
              }

              $('#courseFilter').on('change', function () {
                fetchBatches(currentPage);
              })

              $('#prev-btn').on('click', function () {
                if (currentPage > 1) {
                  currentPage--;
                  fetchBatches(currentPage);
                }
              });


              $('#next-btn').on('click', function () {
                currentPage++;
                fetchBatches(currentPage);
              });


              function setupPagination(totalPages, currentPage) {
                $('#page-info').text(`Page ${currentPage} of ${totalPages}`);

                $('#prev-btn').prop('disabled', currentPage === 1);
                $('#next-btn').prop('disabled', currentPage === totalPages || totalPages === 0);
              }

              $('#batch-form').submit(function (e) {
                e.preventDefault();
                const batchId = $('#batchId').val();
                const formData = {
                  courseId: $('#courseId').val(),
                  name: $('#name').val().trim(),
                  startDate: $('#startDate').val()
                }

                if (!formData.courseId || !formData.name || !formData.startDate) {
                  showMessage('Please fill all the required fileds', 'danger');
                  return;
                }

                if (batchId) {
                  $.ajax({
                    url: `/admin/batches/${batchId}/update`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                      // console.log(response);
                      if (response.status) {
                        showMessage(response.message, 'success');
                        $('#batch-form')[0].reset();
                        $('#batchId').val('');
                        $('#cancelEdit').hide();
                        fetchBatches(currentPage);

                      }
                    },
                    error: function (error) {
                      if (handleAuthRedirect(error)) return;
                      const errMsg = error.responseJSON && error.responseJSON.message ? error.responseJSON.message : 'Something went wrong!';
                      showMessage(errMsg, 'danger');
                    }

                  })


                } else {
                  $.ajax({
                    url: '/admin/batches/add',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                      if (response.status) {
                        showMessage(response.message, 'success');
                        $('#batch-form')[0].reset();
                        fetchBatches(currentPage);

                      }
                    },
                    error: function (error) {
                      if (handleAuthRedirect(error)) return;
                      const errMsg = error.responseJSON && error.responseJSON.message ? error.responseJSON.message : 'Something went wrong!';
                      showMessage(errMsg, 'danger');
                    }

                  })
                }
              });

              $(document).on('click', '.edit-btn', function () {
                const batchId = $(this).data('batch-id');
                editBatch(batchId);
              });


              function editBatch(id) {
                $.ajax({
                  url: '/admin/batches/' + id,
                  type: 'GET',
                  success: function (response) {
                    if (response.status) {
                      // console.log(response.data);
                      $('#courseId').val(response.data.courseId)
                      $('#name').val(response.data.name);
                      $('#startDate').val(new Date(response.data.startDate).toISOString().split("T")[0]);
                      $('#batchId').val(response.data._id);
                      $('#cancelEdit').show();
                      $(`#row-${response.data._id}`).remove();

                    }
                  },
                  error: function (error) {
                    if (handleAuthRedirect(error)) return;
                    const errMsg = error.responseJSON && error.responseJSON.message ? error.responseJSON.message : 'Something went wrong!';
                    alert(errMsg);
                  }
                })
              }

              $('#cancelEdit').on('click', function () {
                $('#batchId').val('')
                $('#batch-form')[0].reset();
                $(this).hide();
                fetchBatches(currentPage);
              });

              $(document).on('click', '.delete-btn', function () {
                const batchId = $(this).data('batch-id');
                deleteBatch(batchId);
              });

              function deleteBatch(id) {
                const conf = confirm('Are you sure you want to delete this batch?');
                if (!conf) {
                  return false;
                }

                $.ajax({
                  url: `/admin/batches/${id}/delete`,
                  type: 'post',
                  success: function (response) {
                    if (response.status) {
                      $(`#row-${id}`).remove();
                    }
                  },
                  error: function (error) {
                    if (handleAuthRedirect(error)) return;
                    const errMsg = error.responseJSON && error.responseJSON.message ? error.responseJSON.message : 'Something went wrong!';
                    alert(errMsg);

                  }
                })

              }



              fetchBatches(currentPage);

              function renderBatches(data) {
                // console.log(data);
                let html = '';
                if (data.length > 0) {
                  data.forEach((batch, index) => {
                    html += `
                                                    <tr class="fade-in" id='row-${batch._id}'>
                                                          <td>${index + 1}</td>
                                                          <td>${batch.course.name}</td>
                                                          <td>${batch.name}</td>
                                                          <td>${new Date(batch.startDate).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', year: 'numeric', month: '2-digit', day: '2-digit' })}</td>
                                                          <td class="text-center">
                                                          <button class="btn btn-sm btn-warning me-1 edit-btn" data-batch-id="${batch._id}">Edit</button>
                                                         <button class="btn btn-sm btn-danger delete-btn" data-batch-id="${batch._id}">Delete</button>
                                                         </td>
                                                     </tr>   
                                                    `
                  })
                } else {
                  html += `
                                                <tr>
                                                <td colspan='5' class='text-center'> No Data Found </td>
                                                </tr>   
                                                `
                }
                // $('#batch-body').append(html);
                $('#batch-body').html(html);
                $('.fade-in').hide().fadeIn(500);
              }


              function showMessage(message, type = 'success') {
                $('#messageArea').html(`
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `);

                setTimeout(() => {
                  $('.alert').alert('close');
                }, 3000);

              }

              function handleAuthRedirect(error) {
                const response = error.responseJSON;
                if (error.status === 401) {
                  window.location.href = '/admin/login';
                  return true;
                }
                return false;
              }


            });
          </script>

  </body>
  <!--end::Body-->

  </html>